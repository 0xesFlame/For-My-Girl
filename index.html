<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ë–û–ô –°–ò–°–¢–ï–ú–´: –ü–†–û–°–ù–ò–°–¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --primary: #ff0000;
            --bg: #000000;
        }

        body.green-mode {
            --primary: #00ff00;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--primary);
            font-family: 'VT323', monospace;
            font-size: 24px;
            height: 1250000px;
            overflow-x: hidden;
            cursor: crosshair;
            transition: filter 1s ease;
            user-select: none;
        }

        body::-webkit-scrollbar { width: 0; }

        /* –ú–ê–¢–†–ò–¶–ê */
        #matrixCanvas {
            position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.25;
        }

        /* UI HEADER */
        #ui-layer {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: black;
            border-bottom: 2px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 2500; padding: 0 20px; box-sizing: border-box;
        }

        .cyber-btn {
            background: black; border: 1px solid var(--primary); color: var(--primary);
            font-family: 'VT323', monospace; font-size: 20px; padding: 5px 15px;
            cursor: pointer; text-transform: uppercase; transition: 0.2s;
            box-shadow: 0 0 5px var(--primary);
        }
        .cyber-btn:hover { background: var(--primary); color: black; }

        .loader-bar { width: 150px; height: 10px; border: 1px solid var(--primary); margin: 5px auto; overflow: hidden; }
        .loader-fill { height: 100%; background: repeating-linear-gradient(45deg, var(--primary), var(--primary) 10px, black 10px, black 20px); width: 200%; animation: load 1s linear infinite; }
        @keyframes load { from { transform: translateX(0); } to { transform: translateX(-28px); } }

        /* –≠–ö–†–ê–ù–´ */
        .full-screen-msg {
            height: 100vh; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
        }
        #final-msg {
            position: absolute; top: 1249500px;
            width: 100%; height: 100vh;
        }

        /* –û–í–ï–†–õ–ï–ô */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .hidden { display: none !important; }

        .cyber-window {
            background: black; border: 2px solid var(--primary);
            box-shadow: 0 0 20px var(--primary); padding: 20px;
            text-align: center; max-width: 600px; width: 95%;
            position: relative;
        }

        /* –ú–ê–ì–ê–ó–ò–ù –ò –ê–î–ú–ò–ù–ö–ê */
        #shop-container {
            position: fixed; top: 70px; left: 20px;
            width: 320px; background: black; border: 2px solid var(--primary);
            z-index: 3000; padding: 10px; display: none;
            max-height: 80vh; overflow-y: auto;
        }
        .shop-item {
            border: 1px solid var(--primary); margin-bottom: 8px; padding: 5px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            font-size: 18px;
        }
        .shop-item:hover { background: rgba(255,0,0,0.3); }

        #admin-panel {
            position: fixed; top: 70px; right: 20px;
            width: 300px; background: black; border: 2px solid var(--primary);
            z-index: 3000; padding: 10px; display: none;
        }

        /* –ò–ì–†–û–í–´–ï –°–¢–ò–õ–ò */
        input { background: black; border: 1px solid var(--primary); color: var(--primary); font-size: 24px; text-align: center; padding: 5px; width: 70%; font-family: inherit; }
        input[type=range] { width: 100%; cursor: pointer; }

        /* 2048 –°—Ç–∏–ª–∏ */
        .game-2048-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            width: 300px;
            height: 300px;
            margin: 0 auto;
            background: #222;
            padding: 5px;
            border: 1px solid var(--primary);
        }
        .tile-2048 {
            display: flex; justify-content: center; align-items: center;
            background: #111; color: var(--primary);
            font-weight: bold; font-size: 18px;
            border: 1px solid #444;
            transition: all 0.1s;
        }
        .tile-val-2 { background: #300; }
        .tile-val-4 { background: #500; }
        .tile-val-8 { background: #700; border-color: red;}
        .tile-val-16 { background: #900; border-color: red;}
        .tile-val-32 { background: #b00; border-color: red;}
        .tile-val-64 { background: #d00; color: white; border-color: red;}
        .tile-val-128 { background: #f00; color: black; border-color: white;}
        /* –°–∞–ø–µ—Ä –°—Ç–∏–ª–∏ */
        .mines-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            width: 320px;
            margin: 0 auto;
            background: #333;
            border: 1px solid var(--primary);
        }
        .mine-cell {
            width: 38px; height: 38px;
            background: #111;
            border: 1px solid #444;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 20px;
            cursor: pointer;
        }
        .mine-cell:hover { background: #222; }
        .mine-cell.revealed { background: black; border: 1px solid #222; cursor: default; }

        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–ï */
        #chaos-warn {
            position: fixed; right: -100vw; top: 100px;
            background: var(--primary); color: black; border: 2px solid white;
            padding: 15px 30px; font-weight: bold; font-size: 28px;
            transition: right 0.5s ease-out; z-index: 4000;
        }

        /* –≠–§–§–ï–ö–¢–´ */
        .shake { animation: shake 0.5s infinite; }
        .darkness { filter: brightness(0); }
        .invert { filter: invert(1); }
        .no-cursor { cursor: none !important; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, 2px); } }
        .falling-obj { position: fixed; top: -50px; font-size: 40px; animation: fall 3s linear forwards; z-index: 5000; pointer-events: none;}
        @keyframes fall { to { top: 110vh; } }
        .fake-cursor {
            position: fixed; width: 20px; height: 20px; 
            background: white; clip-path: polygon(0 0, 0% 100%, 100% 50%);
            z-index: 9999; pointer-events: none; transition: 0.1s;
        }

    </style>
</head>
<body>
    <canvas id="matrixCanvas"></canvas>

    <!-- UI HEADER -->
    <div id="ui-layer">
        <div style="width: 250px;">
            <button class="cyber-btn" id="shop-btn" onclick="toggleShop()">üõí –ú–ê–ì–ê–ó–ò–ù [0$]</button>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 20px; font-weight: bold;">–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê</div>
            <div class="loader-bar"><div class="loader-fill"></div></div>
        </div>
        <div style="width: 250px; text-align: right; cursor: pointer;" id="admin-trigger">
            –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–∑–ª–æ–º–∞: <span id="pct-disp">0.00</span>%
        </div>
    </div>

    <!-- –ú–ê–ì–ê–ó–ò–ù -->
    <div id="shop-container">
        <h3 style="text-align: center; border-bottom: 1px solid var(--primary); margin-top: 0;">–ú–ê–ì–ê–ó–ò–ù</h3>
        <div class="shop-item" onclick="buy('skip')"><span>üß® –ü—Ä–æ–ø—É—Å–∫</span> <span>5000$</span></div>
        <div class="shop-item" onclick="buy('shield')"><span>üõ°Ô∏è –©–∏—Ç (2 –º–∏–Ω)</span> <span>2000$</span></div>
        <div class="shop-item" onclick="buy('insurance')"><span>üíæ –°—Ç—Ä–∞—Ö–æ–≤–∫–∞</span> <span>3000$</span></div>
        <div class="shop-item" onclick="buy('case')"><span>üíº –ö–µ–π—Å —É–¥–∞—á–∏</span> <span>10000$</span></div>
        <div class="shop-item" onclick="buy('x2')"><span>üí∞ –î–æ—Ö–æ–¥ x2</span> <span>15000$</span></div>
        <div class="shop-item" onclick="buy('x3')"><span>üí∞ –î–æ—Ö–æ–¥ x3</span> <span>30000$</span></div>
        <div class="shop-item" onclick="buy('x4')"><span>üí∞ –î–æ—Ö–æ–¥ x4</span> <span>50000$</span></div>
        <div class="shop-item" onclick="buy('x5')"><span>üí∞ –î–æ—Ö–æ–¥ x5</span> <span>100000$</span></div>
        <button class="cyber-btn" onclick="toggleShop()" style="width: 100%; margin-top: 10px;">–ó–ê–ö–†–´–¢–¨</button>
    </div>

    <!-- –ê–î–ú–ò–ù–ö–ê -->
    <div id="admin-panel">
        <h3 style="margin-top:0;">GOD MODE</h3>
        <input id="admin-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width: 90%;">
        <button class="cyber-btn" onclick="authAdmin()" style="width:100%; margin-top:5px;">–í–û–ô–¢–ò</button>
        
        <div id="admin-controls" class="hidden">
            <hr style="border-color: var(--primary);">
            <button class="cyber-btn" onclick="state.money+=100000; updateUI();" style="width:100%">+100,000$</button>
            <button class="cyber-btn" onclick="forceSkip()" style="width:100%; margin-top:5px;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ó–∞–¥–∞–Ω–∏–µ</button>
            <button class="cyber-btn" onclick="resetGame()" style="width:100%; margin-top:5px; color:red; border-color:red;">–°–ë–†–û–° –ü–†–û–ì–†–ï–°–°–ê</button>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px;">
                <button class="cyber-btn" onclick="tpTo(0)">0%</button>
                <button class="cyber-btn" onclick="tpTo(50)">50%</button>
                <button class="cyber-btn" onclick="tpTo(99)">99%</button>
                <button class="cyber-btn" onclick="tpTo(150)">150%</button>
                <button class="cyber-btn" onclick="tpTo(199)">199%</button>
                <button class="cyber-btn" onclick="tpTo(249)">249%</button>
            </div>
            
            <p style="margin: 5px 0;">–í—ã–∑–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ:</p>
            <select id="chaos-sel" style="background:black; color:var(--primary); width:100%; padding: 5px;">
                <option value="tacos">–¢–∞–∫–æ</option>
                <option value="quake">–ó–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ</option>
                <option value="dark">–¢–µ–º–Ω–æ—Ç–∞</option>
                <option value="freeze">–ó–∞–º–æ—Ä–æ–∑–∫–∞</option>
                <option value="invert">–ò–Ω–≤–µ—Ä—Å–∏—è</option>
                <option value="msg">–ß–∞—Ç</option>
                <option value="fly">–ú—É—Ö–∞</option>
                <option value="multi">–ú—É–ª—å—Ç–∏-–∫—É—Ä—Å–æ—Ä</option>
                <option value="twilight">–°—É–º–µ—Ä–∫–∏ (No Cursor)</option>
            </select>
            <button class="cyber-btn" onclick="forceChaos()" style="width:100%; margin-top:5px;">–í–´–ó–í–ê–¢–¨</button>
            <button class="cyber-btn" onclick="document.getElementById('admin-panel').style.display='none'" style="width: 100%; margin-top: 10px;">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï -->
    <div id="chaos-warn">‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –°–ë–û–ô –í –°–ò–°–¢–ï–ú–ï!!!</div>

    <!-- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù -->
    <div class="full-screen-msg">
        <h1 style="font-size: 60px;">–î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù</h1>
        <p>–õ–∏—Å—Ç–∞–π –≤–Ω–∏–∑ –¥–ª—è –≤–∑–ª–æ–º–∞...</p>
        <button class="cyber-btn" id="runaway-btn" style="position:relative;">–í–ó–õ–û–ú–ê–¢–¨</button>
    </div>

    <!-- –§–ò–ù–ê–õ -->
    <div id="final-msg" class="full-screen-msg">
        <h1 style="font-size: 50px;">–°–ò–°–¢–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –í–ó–õ–û–ú–ê–ù–ê</h1>
        <div style="background: black; border: 4px dashed var(--primary); padding: 40px;">
            <h2 style="margin: 0;">–°–õ–ï–î–£–Æ–©–ê–Ø –ü–û–î–°–ö–ê–ó–ö–ê –ü–†–ò–ö–õ–ï–ï–ù–ê<br>–°–ö–û–¢–ß–ï–ú –ó–ê –¢–í–û–ò–ú –¢–ï–õ–ï–í–ò–ó–û–†–û–ú</h2>
        </div>
    </div>

    <!-- –û–ö–ù–û –ó–ê–î–ê–ù–ò–Ø -->
    <div id="task-overlay" class="overlay hidden">
        <div class="cyber-window">
            <h2 id="task-title">–ó–ê–ì–†–£–ó–ö–ê...</h2>
            <div id="task-timer" style="color:yellow; font-weight:bold; font-size: 30px; margin-bottom: 10px;"></div>
            <div id="task-body" style="margin: 20px 0;"></div>
        </div>
    </div>

<script>
/* ================== CONFIG ================== */
const TOTAL_HEIGHT = 1250000;
const SCROLL_FACTOR = TOTAL_HEIGHT / 250; 
let state = {
    locked: false,
    money: 0,
    multiplier: 1,
    progress: 0,
    checkpoint: 0,
    activeTask: null,
    inventory: { shield: false, insurance: false },
    tasksSolved: []
};
let currentTimer = null;

// –ü–£–õ –ó–ê–ì–ê–î–û–ö
const RIDDLES_POOL = [
    {q: '–ó–∏–º–æ–π –∏ –ª–µ—Ç–æ–º –æ–¥–Ω–∏–º —Ü–≤–µ—Ç–æ–º?', a: '–µ–ª–∫–∞'},
    {q: '–ù–µ –ª–∞–µ—Ç, –Ω–µ –∫—É—Å–∞–µ—Ç, –∞ –≤ –¥–æ–º –Ω–µ –ø—É—Å–∫–∞–µ—Ç?', a: '–∑–∞–º–æ–∫'},
    {q: '–í—Å–µ–≥–¥–∞ –≤–æ —Ä—Ç—É, –∞ –Ω–µ –ø—Ä–æ–≥–ª–æ—Ç–∏—à—å?', a: '—è–∑—ã–∫'},
    {q: '–í–∏—Å–∏—Ç –≥—Ä—É—à–∞ - –Ω–µ–ª—å–∑—è —Å–∫—É—à–∞—Ç—å?', a: '–ª–∞–º–ø–æ—á–∫–∞'},
    {q: '–ß—Ç–æ –º–æ–∂–Ω–æ —Å–ª–æ–º–∞—Ç—å, –µ—Å–ª–∏ –Ω–∞–∑–≤–∞—Ç—å?', a: '—Ç–∏—à–∏–Ω–∞'},
    {q: '–ë–µ–∑ —Ä—É–∫, –±–µ–∑ –Ω–æ–≥, –∞ —Ä–∏—Å–æ–≤–∞—Ç—å —É–º–µ–µ—Ç?', a: '–º–æ—Ä–æ–∑'},
    {q: '–£ –∫–æ–≥–æ –µ—Å—Ç—å —à–∞–ø–∫–∞ –±–µ–∑ –≥–æ–ª–æ–≤—ã?', a: '–≥—Ä–∏–±'}
];

// –ü–£–õ –°–¢–†–ê–®–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô
const CREEPY_MSGS = [
    "üëÅÔ∏è –Ø –í–ò–ñ–£ –¢–ï–ë–Ø...", "–û–ë–ï–†–ù–ò–°–¨...", "–¢–´ –ù–ï –û–î–ù–ê...", 
    "–°–ò–°–¢–ï–ú–ê –°–õ–ï–î–ò–¢...", "–ù–ï –°–ü–ê–¢–¨...", "–í–†–ï–ú–Ø –ò–°–¢–ï–ö–ê–ï–¢..."
];

const TASKS = [
    { pct: 10, type: 'riddle', t: 30 },
    { pct: 20, type: 'math', lvl: 1, t: 20 },
    { pct: 25, type: 'memory', t: 10 },
    { pct: 30, type: 'color', t: 20 },
    { pct: 35, type: 'math', lvl: 2, t: 20 },
    { pct: 40, type: 'slider', t: 15 },
    { pct: 45, type: 'riddle', t: 30 },
    { pct: 50, type: 'math', lvl: 3, t: 20 },
    { pct: 55, type: 'findOdd', t: 15 },
    { pct: 60, type: 'typing', t: 20 },
    { pct: 65, type: 'math', lvl: 4, t: 20 },
    { pct: 70, type: 'dontPress', t: 10 },
    { pct: 75, type: 'clicker', t: 5 },
    { pct: 80, type: 'riddle', t: 30 },
    { pct: 85, type: 'math', lvl: 5, t: 20 },
    { pct: 90, type: '2048', t: 0 },
    { pct: 95, type: 'mines', t: 0 },
    { pct: 100, type: 'checkpoint' },
    // –ü–£–°–¢–û–®–¨
    { pct: 150, type: 'quiz', t: 0 },
    { pct: 195, type: 'colorChange' },
    { pct: 200, type: 'checkpoint' },
    { pct: 210, type: 'sheep', count: 3, t: 0 },
    { pct: 220, type: 'flags', t: 0 },
    { pct: 230, type: 'sheep', count: 6, t: 0 },
    { pct: 250, type: 'final' }
];

/* ================== START ================== */
window.onload = () => {
    initMatrix();
    initRunaway();
    setInterval(economyLoop, 60000);
    setInterval(chaosLoop, 30000);
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è 2048
    document.addEventListener('keydown', handleGlobalKey);
};

/* ================== SCROLL ENGINE ================== */
window.onscroll = () => {
    let y = window.scrollY;
    let pct = y / SCROLL_FACTOR;
    state.progress = pct;
    document.getElementById('pct-disp').innerText = pct.toFixed(2);
    
    if (pct >= 195) document.body.classList.add('green-mode');
    else document.body.classList.remove('green-mode');

    if (state.locked && state.activeTask) {
        let taskY = state.activeTask.pct * SCROLL_FACTOR;
        if (Math.abs(y - taskY) > 50) window.scrollTo(0, taskY);
        return;
    }
    checkTaskTrigger(pct);
};

function checkTaskTrigger(pct) {
    let task = TASKS.find(t => pct >= t.pct && pct < t.pct + 0.1);
    
    if (task) {
        if (state.tasksSolved.includes(task.pct)) return;

        if (task.type === 'checkpoint') {
            state.checkpoint = task.pct;
            notify("üö© –ß–ï–ö–ü–û–ò–ù–¢ –°–û–•–†–ê–ù–ï–ù!");
            state.tasksSolved.push(task.pct);
        } else if (task.type === 'colorChange') {
            // Visual
        } else if (task.type === 'final') {
            // End
        } else {
            triggerTask(task);
        }
    }
}

function triggerTask(task) {
    if (state.locked) return;
    state.locked = true;
    state.activeTask = task;
    document.body.style.overflow = 'hidden';
    document.getElementById('task-overlay').classList.remove('hidden');
    renderTask(task);
}

function unlock() {
    state.locked = false;
    document.body.style.overflow = 'auto';
    document.getElementById('task-overlay').classList.add('hidden');
    if (currentTimer) clearInterval(currentTimer);
    
    if (state.activeTask) {
        state.tasksSolved.push(state.activeTask.pct);
        state.money += 100;
        updateUI();
        notify("–ó–ê–î–ê–ù–ò–ï –í–´–ü–û–õ–ù–ï–ù–û (+100$)");
        window.scrollBy(0, 300); 
    }
    state.activeTask = null;
}

function failTask(msg) {
    if (currentTimer) clearInterval(currentTimer);

    if (state.inventory.insurance) {
        state.inventory.insurance = false;
        notify("üõ°Ô∏è –°–¢–†–ê–•–û–í–ö–ê –°–ü–ê–°–õ–ê –í–ê–°!");
        state.locked = false;
        document.body.style.overflow = 'auto';
        document.getElementById('task-overlay').classList.add('hidden');
        window.scrollBy(0, -100);
        return;
    }

    alert(msg || "–û–®–ò–ë–ö–ê! –°–ò–°–¢–ï–ú–ê –ü–ï–†–ï–ó–ê–ì–†–£–ñ–ê–ï–¢–°–Ø...");
    state.tasksSolved = state.tasksSolved.filter(pct => pct <= state.checkpoint);
    state.locked = false;
    state.activeTask = null;
    document.body.style.overflow = 'auto';
    document.getElementById('task-overlay').classList.add('hidden');
    window.scrollTo(0, state.checkpoint * SCROLL_FACTOR);
}

/* ================== –ó–ê–î–ê–ù–ò–Ø ================== */
function renderTask(t) {
    let body = document.getElementById('task-body');
    let title = document.getElementById('task-title');
    let timerDiv = document.getElementById('task-timer');
    body.innerHTML = '';
    title.innerText = "–í–ó–õ–û–ú –ü–†–û–¢–û–ö–û–õ–ê";
    timerDiv.innerText = '';

    if (t.t > 0 && t.type !== 'dontPress') {
        let time = t.t;
        timerDiv.innerText = time;
        currentTimer = setInterval(() => {
            time--;
            timerDiv.innerText = time;
            if (time <= 0) failTask("–í–†–ï–ú–Ø –ò–°–¢–ï–ö–õ–û!");
        }, 1000);
    }

    if (t.type === 'math') {
        let n1 = Math.floor(Math.random()*10*t.lvl)+5;
        let n2 = Math.floor(Math.random()*10*t.lvl)+5;
        let ans = n1+n2;
        body.innerHTML = `<h3>${n1} + ${n2} = ?</h3><input id="ans" type="number"><br><br><button class="cyber-btn" onclick="checkAns(${ans})">OK</button>`;
    }
    else if (t.type === 'riddle') {
        let r = RIDDLES_POOL[Math.floor(Math.random() * RIDDLES_POOL.length)];
        body.innerHTML = `<p>${r.q}</p><input id="ans"><br><br><button class="cyber-btn" onclick="checkStr('${r.a}')">OK</button>`;
    }
    else if (t.type === 'color') {
        let colors = ['red','green','blue','yellow'];
        let trueC = colors[Math.floor(Math.random()*4)];
        let textC = colors[Math.floor(Math.random()*4)].toUpperCase();
        let ru = {'red':'–ö–†–ê–°–ù–´–ô','green':'–ó–ï–õ–ï–ù–´–ô','blue':'–°–ò–ù–ò–ô','yellow':'–ñ–ï–õ–¢–´–ô'};
        body.innerHTML = `<h1 style="color:${trueC};font-size:50px;">${ru[textC]||textC}</h1><p>–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ü–≤–µ—Ç–∞ <b>–¢–ï–ö–°–¢–ê</b></p>`;
        let d = document.createElement('div');
        colors.forEach(c => {
            let b = document.createElement('button');
            b.style.backgroundColor = c; b.style.width='60px'; b.style.height='60px'; b.style.margin='10px'; b.style.border='2px solid white';
            b.onclick = () => { if(c===trueC) unlock(); else failTask("–ù–ï –¢–û–¢ –¶–í–ï–¢!"); };
            d.appendChild(b);
        });
        body.appendChild(d);
    }
    else if (t.type === 'dontPress') {
        body.innerHTML = `<h3>–ù–ï –ù–ê–ñ–ò–ú–ê–ô 10 –°–ï–ö–£–ù–î</h3><button id="bad-btn" class="cyber-btn" style="color:red;border-color:red; padding:20px;">–Ø –ù–ï –ú–û–ì–£ –¢–ï–†–ü–ï–¢–¨</button>`;
        let btn = document.getElementById('bad-btn');
        // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –Ω–∞–∂–∞–ª —Å—Ä–∞–∑—É - —Å–º–µ—Ä—Ç—å
        btn.onclick = () => failTask('–¢–´ –ù–ï –í–´–¢–ï–†–ü–ï–õ–ê!');
        
        let time = 10;
        timerDiv.innerText = time;
        currentTimer = setInterval(() => {
            time--;
            timerDiv.innerText = time;
            if (time <= 0) {
                clearInterval(currentTimer);
                btn.innerText = "–í–ó–õ–û–ú–ê–¢–¨";
                btn.style.color = "#0f0";
                btn.style.borderColor = "#0f0";
                btn.onclick = unlock; // –¢–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∞ –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç
            }
        }, 1000);
    }
    else if (t.type === 'clicker') {
        let count = 0;
        body.innerHTML = `<h3>–ö–õ–ò–ö–ù–ò 10 –†–ê–ó!</h3><button id="click-btn" class="cyber-btn">–ñ–ú–ò (0/10)</button>`;
        let b = document.getElementById('click-btn');
        b.onclick = () => {
            count++; b.innerText = `–ñ–ú–ò (${count}/10)`;
            b.style.position = 'relative';
            b.style.left = (Math.random()*300 - 150)+'px';
            b.style.top = (Math.random()*100 - 50)+'px';
            if(count>=10) unlock();
        };
    }
    else if (t.type === 'typing') {
        let phrases = ["—è –ª—é–±–ª—é —Ç–µ–±—è", "—Å–∏—Å—Ç–µ–º–Ω—ã–π —Å–±–æ–π", "–º–∞—Ç—Ä–∏—Ü–∞", "–¥–æ—Å—Ç—É–ø", "–∫–æ–¥ 1379"];
        let p = phrases[Math.floor(Math.random()*phrases.length)];
        body.innerHTML = `<p>–ù–∞–ø–µ—á–∞—Ç–∞–π: <b>${p}</b></p><input id="ans"><button class="cyber-btn" onclick="checkStr('${p}')">OK</button>`;
    }
    else if (t.type === 'findOdd') {
        let grid = document.createElement('div');
        grid.style.display = 'grid'; grid.style.gridTemplateColumns='repeat(5,1fr)';
        let odd = Math.floor(Math.random()*25);
        for(let i=0; i<25; i++) {
            let s = document.createElement('span');
            s.style.fontSize='30px'; s.style.cursor='pointer';
            s.innerText = (i===odd) ? 'ü§ë' : 'üòé';
            s.onclick = () => { if(i===odd) unlock(); else failTask('–ù–ï –¢–û–¢!'); };
            grid.appendChild(s);
        }
        body.appendChild(grid);
    }
    else if (t.type === 'memory') {
        let n = Math.floor(Math.random()*9000)+1000;
        body.innerHTML = `<h1>${n}</h1>`;
        setTimeout(() => {
            body.innerHTML = `<input type="number" id="ans" placeholder="–ß–∏—Å–ª–æ?"><button class="cyber-btn" onclick="checkAns(${n})">OK</button>`;
        }, 2000);
    }
    else if (t.type === 'slider') {
        let target = Math.floor(Math.random()*100);
        let randomMin = Math.floor(Math.random() * 50) - 50; 
        let randomMax = Math.floor(Math.random() * 100) + 100;
        
        body.innerHTML = `
            <p>–í—ã—Å—Ç–∞–≤—å –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–≤–Ω–æ –Ω–∞: <b>${target}</b></p>
            <div style="font-size:40px; color:yellow" id="slider-val">0</div>
            <input type="range" min="${randomMin}" max="${randomMax}" value="${randomMin}" id="rng">
            <br><br>
            <button class="cyber-btn" id="slider-stop">–°–¢–û–ü</button>
        `;
        let rng = document.getElementById('rng');
        let disp = document.getElementById('slider-val');
        rng.oninput = function() { disp.innerText = this.value; }
        document.getElementById('slider-stop').onclick = function() {
            if(parseInt(rng.value) === target) unlock();
            else failTask('–ú–ò–ú–û! (' + rng.value + ')');
        }
    }
    else if (t.type === '2048') {
        init2048(body);
    }
    else if (t.type === 'mines') {
        initMines(body);
    }
    else if (t.type === 'sheep') {
        initSheep(body, t.count);
    }
    else if (t.type === 'flags') {
        initFlags(body);
    }
    else if (t.type === 'quiz') {
        let qs = [{q:"–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?", a:"–ø–∞—Ä–∏–∂"}, {q:"2+2*2?", a:"6"}];
        let curr = 0;
        function showQ() {
            if(curr>=qs.length) { unlock(); return; }
            body.innerHTML = `<p>${qs[curr].q}</p><input id="qans"><button class="cyber-btn" onclick="checkQ()">OK</button>`;
        }
        window.checkQ = () => { if(document.getElementById('qans').value.toLowerCase().trim() === qs[curr].a) { curr++; showQ(); } else failTask("–û–®–ò–ë–ö–ê!"); }
        showQ();
    }
}

window.checkAns = (c) => { if(parseInt(document.getElementById('ans').value)===c) unlock(); else failTask("–ù–ï–í–ï–†–ù–û!"); }
window.checkStr = (c) => { if(document.getElementById('ans').value.toLowerCase().trim().includes(c)) unlock(); else failTask("–ù–ï–í–ï–†–ù–û!"); }

/* ================== –ò–ì–†–ê 2048 (–î–í–ò–ñ–û–ö) ================== */
let grid2048 = [];
function init2048(container) {
    // 6x6 grid = 36 cells
    grid2048 = Array(36).fill(0);
    spawn2048(); spawn2048();
    render2048(container);
    // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    let p = document.createElement('p');
    p.innerText = "–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä–µ–ª–æ—á–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ. –°–æ–±–µ—Ä–∏ 2048.";
    container.appendChild(p);
}

function spawn2048() {
    let empty = grid2048.map((v,i) => v===0 ? i : -1).filter(v => v !== -1);
    if(empty.length > 0) {
        let idx = empty[Math.floor(Math.random()*empty.length)];
        grid2048[idx] = Math.random() > 0.9 ? 4 : 2;
    }
}

function render2048(container) {
    let div = container.querySelector('.game-2048-container');
    if(!div) {
        div = document.createElement('div');
        div.className = 'game-2048-container';
        container.insertBefore(div, container.firstChild);
    }
    div.innerHTML = '';
    grid2048.forEach(v => {
        let tile = document.createElement('div');
        tile.className = `tile-2048 tile-val-${v}`;
        tile.innerText = v || '';
        div.appendChild(tile);
    });
}

function handleGlobalKey(e) {
    if(!state.activeTask || state.activeTask.type !== '2048') return;
    
    // –í–ª–µ–≤–æ = 0, –í–≤–µ—Ä—Ö = 1, –í–ø—Ä–∞–≤–æ = 2, –í–Ω–∏–∑ = 3 (–¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è)
    // –ù–æ —Ç–∞–∫ –∫–∞–∫ –ª–æ–≥–∏–∫–∞ —Å–ª–æ–∂–Ω–∞—è, —Å–¥–µ–ª–∞–µ–º –ø—Ä–æ—Å—Ç–æ –ø–æ –∫–Ω–æ–ø–∫–∞–º
    let moved = false;
    
    if(e.key === 'ArrowLeft') moved = move2048(0);
    else if(e.key === 'ArrowUp') moved = move2048(1);
    else if(e.key === 'ArrowRight') moved = move2048(2);
    else if(e.key === 'ArrowDown') moved = move2048(3);
    
    if(moved) {
        spawn2048();
        render2048(document.getElementById('task-body'));
        if(grid2048.includes(2048)) unlock();
        if(!grid2048.includes(0)) {
            // Check if moves possible
            // Simplified check: fail if full
             failTask("–ù–ï–¢ –•–û–î–û–í!");
        }
    }
}

// –ü—Ä–æ—Å—Ç–æ–π –¥–≤–∏–∂–æ–∫ —Å–¥–≤–∏–≥–∞ –º–∞—Å—Å–∏–≤–∞
function move2048(dir) {
    // dir: 0-left, 1-up, 2-right, 3-down
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 1d –º–∞—Å—Å–∏–≤ –≤ 2d (6x6) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    let size = 6;
    let matrix = [];
    for(let i=0; i<size; i++) matrix.push(grid2048.slice(i*size, (i+1)*size));
    
    // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É —Ç–∞–∫, —á—Ç–æ–±—ã –º—ã –≤—Å–µ–≥–¥–∞ —Å–¥–≤–∏–≥–∞–ª–∏ –í–õ–ï–í–û
    let rotations = 0;
    if(dir === 1) rotations = 3; // Up -> Rotate 270 (or 3 times 90)
    if(dir === 2) rotations = 2; // Right -> Rotate 180
    if(dir === 3) rotations = 1; // Down -> Rotate 90
    
    for(let k=0; k<rotations; k++) matrix = rotateMatrix(matrix);
    
    let changed = false;
    // –°–¥–≤–∏–≥ –≤–ª–µ–≤–æ
    for(let i=0; i<size; i++) {
        let row = matrix[i].filter(v => v); // –£–±—Ä–∞—Ç—å –Ω—É–ª–∏
        for(let j=0; j<row.length-1; j++) {
            if(row[j] === row[j+1]) {
                row[j] *= 2;
                row[j+1] = 0;
            }
        }
        row = row.filter(v => v); // –°–Ω–æ–≤–∞ —É–±—Ä–∞—Ç—å –Ω—É–ª–∏ –ø–æ—Å–ª–µ —Å–ª–∏—è–Ω–∏—è
        while(row.length < size) row.push(0); // –î–æ–ø–æ–ª–Ω–∏—Ç—å –Ω—É–ª—è–º–∏
        if(matrix[i].join(',') !== row.join(',')) changed = true;
        matrix[i] = row;
    }
    
    // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
    let backRotations = (4 - rotations) % 4;
    for(let k=0; k<backRotations; k++) matrix = rotateMatrix(matrix);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ 1d –º–∞—Å—Å–∏–≤
    grid2048 = matrix.flat();
    return changed;
}

function rotateMatrix(m) {
    // –ü–æ–≤–æ—Ä–æ—Ç 90 –≥—Ä–∞–¥—É—Å–æ–≤ –ø–æ —á–∞—Å–æ–≤–æ–π
    let n = m.length;
    let res = Array.from({length:n}, ()=>Array(n).fill(0));
    for(let i=0; i<n; i++) {
        for(let j=0; j<n; j++) {
            res[j][n-1-i] = m[i][j];
        }
    }
    return res;
}

/* ================== –°–ê–ü–ï–† (–î–í–ò–ñ–û–ö) ================== */
let minesGrid = [];
let minesData = []; // -1 mine, 0-8 count
function initMines(container) {
    // 8x8 grid = 64 cells
    minesData = Array(64).fill(0);
    let bombCount = 12;
    let bombs = 0;
    while(bombs < bombCount) {
        let idx = Math.floor(Math.random()*64);
        if(minesData[idx] !== -1) {
            minesData[idx] = -1;
            bombs++;
        }
    }
    
    // Calculate numbers
    for(let i=0; i<64; i++) {
        if(minesData[i] === -1) continue;
        let x = i % 8;
        let y = Math.floor(i / 8);
        let count = 0;
        // Check neighbors
        for(let dx=-1; dx<=1; dx++) {
            for(let dy=-1; dy<=1; dy++) {
                let nx = x+dx; let ny = y+dy;
                if(nx>=0 && nx<8 && ny>=0 && ny<8) {
                    if(minesData[ny*8+nx] === -1) count++;
                }
            }
        }
        minesData[i] = count;
    }
    
    // HTML
    container.innerHTML = `<div class="mines-grid"></div><p>–û—Ç–∫—Ä–æ–π 40 –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫</p>`;
    let gridDiv = container.querySelector('.mines-grid');
    for(let i=0; i<64; i++) {
        let c = document.createElement('div');
        c.className = 'mine-cell';
        c.onclick = () => revealMine(i, c);
        gridDiv.appendChild(c);
    }
    state.safeCount = 0;
}

function revealMine(idx, el) {
    if(el.classList.contains('revealed')) return;
    
    let val = minesData[idx];
    if(val === -1) {
        el.style.background = 'red';
        el.innerText = 'üí£';
        failTask("–¢–´ –ü–û–î–û–†–í–ê–õ–ê–°–¨!");
    } else {
        el.classList.add('revealed');
        el.style.color = val === 1 ? 'cyan' : val === 2 ? 'lime' : val >= 3 ? 'red' : 'gray';
        el.innerText = val > 0 ? val : '';
        state.safeCount++;
        if(state.safeCount >= 40) unlock();
    }
}

function initSheep(container, count) {
    container.innerHTML = `<div id="pasture" style="width:100%;height:200px;border:1px dashed green;position:relative;"></div><p>–ö–ª–∏–∫–Ω–∏ –æ–≤–µ—á–µ–∫ —á—Ç–æ–±—ã –ø–æ–∫–æ—Ä–º–∏—Ç—å</p>`;
    let fed = 0;
    for(let i=0; i<count; i++) {
        let s = document.createElement('div'); s.innerText = 'üêë'; s.style.position='absolute';
        s.style.left=Math.random()*90+'%'; s.style.top=Math.random()*80+'%'; s.style.fontSize='30px'; s.style.cursor='pointer';
        s.onclick = function() { this.innerText='üçñ'; fed++; if(fed>=count) unlock(); this.onclick=null;}
        document.getElementById('pasture').appendChild(s);
    }
}

function initFlags(container) {
    let f = [{c:'–§—Ä–∞–Ω—Ü–∏—è',f:'üá´üá∑'},{c:'–Ø–ø–æ–Ω–∏—è',f:'üáØüáµ'},{c:'–°–®–ê',f:'üá∫üá∏'}];
    let curr=0;
    function next() {
        if(curr>=f.length) { unlock(); return; }
        container.innerHTML = `<h1 style="font-size:60px">${f[curr].f}</h1>`;
        f.forEach(item => {
            let b = document.createElement('button'); b.className='cyber-btn'; b.innerText=item.c; b.style.margin='5px';
            b.onclick = () => { if(item.c===f[curr].c) { curr++; next(); } else failTask("–ù–ï–í–ï–†–ù–û!"); }
            container.appendChild(b);
        });
    }
    next();
}

/* ================== ECONOMY ================== */
function economyLoop() {
    let inc = 900 * state.multiplier;
    state.money += inc;
    updateUI();
    notify(`üí∞ –ó–ü: +${inc}$`);
}
function updateUI() {
    document.getElementById('shop-btn').innerText = `üõí –ú–ê–ì–ê–ó–ò–ù [${state.money}$]`;
}
function toggleShop() {
    let s = document.getElementById('shop-container'); s.style.display = s.style.display==='block'?'none':'block';
}
function buy(item) {
    let costs = { 'skip': 5000, 'shield': 2000, 'insurance': 3000, 'case': 10000, 'x2': 15000, 'x3': 30000, 'x4': 50000, 'x5': 100000 };
    if (state.money >= costs[item]) {
        state.money -= costs[item];
        if (item === 'skip') { if(state.locked) unlock(); else notify("–ö—É–ø–ª–µ–Ω–æ."); }
        else if (item === 'shield') { state.inventory.shield = true; notify("–©–∏—Ç (2 –º–∏–Ω)"); setTimeout(()=>state.inventory.shield=false, 120000); }
        else if (item === 'insurance') { state.inventory.insurance = true; notify("–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞"); }
        else if (item.startsWith('x')) { state.multiplier = parseInt(item[1]); notify(`–î–æ—Ö–æ–¥ x${item[1]}`); }
        else if (item === 'case') { Math.random()>0.5 ? (state.money+=20000, notify("–í–´–ò–ì–†–´–®: +20k$")) : notify("–ü–£–°–¢–û..."); }
        updateUI();
    } else alert("–ù–ï–¢ –î–ï–ù–ï–ì");
}

/* ================== CHAOS ================== */
function chaosLoop() {
    if(state.locked || state.inventory.shield) return;
    let w = document.getElementById('chaos-warn');
    w.style.right = '20px'; 
    setTimeout(() => {
        w.style.right = '-100vw'; 
        let effects = ['tacos','quake','dark','freeze','invert','msg','fly','multi','twilight'];
        triggerChaosEffect(effects[Math.floor(Math.random()*effects.length)]);
    }, 3000);
}

function triggerChaosEffect(eff) {
    if(eff==='tacos') spawnEmoji('üåÆ');
    if(eff==='fly') spawnEmoji('ü™∞');
    if(eff==='quake') { document.body.classList.add('shake'); setTimeout(()=>document.body.classList.remove('shake'), 4000); }
    if(eff==='dark') { document.body.classList.add('darkness'); setTimeout(()=>document.body.classList.remove('darkness'), 5000); }
    if(eff==='invert') { document.body.classList.add('invert'); setTimeout(()=>document.body.classList.remove('invert'), 5000); }
    if(eff==='freeze') { document.body.style.overflow='hidden'; setTimeout(()=>document.body.style.overflow='auto', 3000); }
    if(eff==='msg') {
        let txt = CREEPY_MSGS[Math.floor(Math.random() * CREEPY_MSGS.length)];
        notify(txt);
    }
    if(eff==='twilight') { document.body.classList.add('no-cursor'); setTimeout(()=>document.body.classList.remove('no-cursor'), 5000); }
    if(eff==='multi') {
        let fakes = [];
        for(let i=0; i<10; i++) {
            let f = document.createElement('div'); f.className='fake-cursor';
            document.body.appendChild(f); fakes.push(f);
        }
        document.onmousemove = (e) => {
            fakes.forEach((f,i) => {
                setTimeout(() => { f.style.left=e.clientX+'px'; f.style.top=e.clientY+'px'; }, i*50);
            });
        };
        setTimeout(()=> { fakes.forEach(f=>f.remove()); document.onmousemove=null; }, 5000);
    }
}

function spawnEmoji(char) {
    for(let i=0; i<20; i++) {
        let e = document.createElement('div'); e.className = 'falling-obj'; e.innerText = char;
        e.style.left = Math.random()*100 + 'vw'; e.style.animationDuration = (2+Math.random()*3)+'s';
        document.body.appendChild(e); setTimeout(()=>e.remove(), 5000);
    }
}

/* ================== UTILS ================== */
let ac = 0;
document.getElementById('admin-trigger').onclick = () => {
    ac++; if(ac===5) { document.getElementById('admin-panel').style.display='block'; ac=0; }
    setTimeout(()=>ac=0, 2000);
}
function authAdmin() { if(document.getElementById('admin-pass').value==='1379') document.getElementById('admin-controls').classList.remove('hidden'); }
function forceSkip() { if(state.locked) unlock(); }
function resetGame() { localStorage.clear(); location.reload(); }
function tpTo(p) { state.locked=false; document.getElementById('task-overlay').classList.add('hidden'); document.body.style.overflow='auto'; window.scrollTo(0, p * SCROLL_FACTOR); }
function forceChaos() { triggerChaosEffect(document.getElementById('chaos-sel').value); }
function notify(txt) {
    let n = document.createElement('div'); n.innerText = txt;
    n.style = "position:fixed;bottom:20px;right:20px;background:var(--primary);color:black;padding:10px;font-weight:bold;z-index:9000;border:1px solid var(--primary);";
    document.body.appendChild(n); setTimeout(()=>n.remove(), 3000);
}

function initMatrix() {
    let c = document.getElementById('matrixCanvas');
    let ctx = c.getContext('2d');
    c.width = window.innerWidth; c.height = window.innerHeight;
    let cols = Math.floor(c.width/20);
    let drops = Array(cols).fill(1);
    function draw() {
        ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(0,0,c.width,c.height);
        ctx.fillStyle = document.body.classList.contains('green-mode')?'#0f0':'#f00';
        ctx.font = '15px monospace';
        drops.forEach((y,i)=>{
            ctx.fillText(String.fromCharCode(0x30A0+Math.random()*96), i*20, y*20);
            if(y*20>c.height && Math.random()>0.975) drops[i]=0;
            drops[i]++;
        });
    }
    setInterval(draw, 50);
}

function initRunaway() {
    let b = document.getElementById('runaway-btn');
    b.onmouseenter = () => {
        b.style.top = (Math.random()*300)+'px';
        b.style.left = (Math.random()*300-150)+'px';
    }
}
</script>
</body>
</html>
